<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoAS Developer Control Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }
        
        button {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: #3498db;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        
        .preview {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #2ecc71;
            color: white;
            display: none;
            max-width: 300px;
            z-index: 1000;
        }
        
        .status.error {
            background: #e74c3c;
        }
        
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .netlify-status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .netlify-status.online {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
        }
        
        .netlify-status.offline {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }
        
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Simple authentication check -->
    <script>
        // Check if user is authenticated
        if (sessionStorage.getItem('coasDevAuthenticated') !== 'true') {
            // Redirect to login if not authenticated
            window.location.href = "login.html";
        }
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('coasDevAuthenticated');
            window.location.href = "index.html";
        }
    </script>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1><i class="fas fa-tools"></i> CoAS Developer Panel</h1>
            <button onclick="logout()" style="width: auto; padding: 8px 15px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        
        <div class="netlify-status offline" id="netlifyStatus">
            <span class="loader" id="netlifyLoader"></span>
            <span id="netlifyStatusText">Testing Netlify connection...</span>
        </div>
        
        <div class="form-group">
            <label for="activity">Activity Name</label>
            <input type="text" id="activity" placeholder="Enter activity name">
        </div>
        
        <div class="form-group">
            <label for="time">Start Time</label>
            <input type="time" id="time">
        </div>
        
        <div class="form-group">
            <label for="image">Image URL (Optional)</label>
            <input type="url" id="image" placeholder="https://example.com/image.jpg">
        </div>
        
        <button onclick="saveActivity()" id="saveButton">
            <span class="loader" id="saveLoader" style="display: none;"></span>
            <span id="saveText">Save Activity</span>
        </button>
        
        <div class="actions">
            <button onclick="clearActivity()" id="clearButton">
                <span class="loader" id="clearLoader" style="display: none;"></span>
                <span id="clearText">Clear Activity</span>
            </button>
            <button class="primary" onclick="viewActivity()">View Activity Page</button>
        </div>
        
        <div class="preview">
            <h3>Preview:</h3>
            <div id="previewContent">
                No activity set yet
            </div>
        </div>
    </div>
    
    <div id="status" class="status"></div>

    <script>
        // Test Netlify connection on page load
        document.addEventListener('DOMContentLoaded', function() {
            testNetlifyConnection();
        });
        
        // Test if Netlify Functions are working
        async function testNetlifyConnection() {
            const statusElement = document.getElementById('netlifyStatus');
            const statusText = document.getElementById('netlifyStatusText');
            const loader = document.getElementById('netlifyLoader');
            
            try {
                const response = await fetch('/.netlify/functions/retrieve-activity');
                
                if (response.ok) {
                    const data = await response.json();
                    statusText.textContent = 'Netlify Functions: Online';
                    statusElement.classList.remove('offline');
                    statusElement.classList.add('online');
                    loader.style.display = 'none';
                    
                    // Load activity data
                    if (data.success && data.activity) {
                        document.getElementById('activity').value = data.activity.activity || '';
                        document.getElementById('time').value = data.activity.time || '';
                        document.getElementById('image').value = data.activity.image || '';
                        updatePreview();
                    }
                } else {
                    throw new Error('Response not OK');
                }
            } catch (error) {
                statusText.textContent = 'Netlify Functions: Offline - ' + error.message;
                statusElement.classList.remove('online');
                statusElement.classList.add('offline');
                loader.style.display = 'none';
                showStatus('Netlify functions are not available. Please check your deployment.', true);
            }
        }
        
        // Save activity to Netlify
        async function saveActivity() {
            const activity = document.getElementById('activity').value;
            const time = document.getElementById('time').value;
            const image = document.getElementById('image').value;
            
            if (!activity || !time) {
                showStatus('Please enter both activity name and time', true);
                return;
            }
            
            // Show loading state
            const saveButton = document.getElementById('saveButton');
            const saveText = document.getElementById('saveText');
            const saveLoader = document.getElementById('saveLoader');
            
            saveButton.disabled = true;
            saveText.textContent = 'Saving...';
            saveLoader.style.display = 'inline-block';
            
            try {
                const response = await fetch('/.netlify/functions/store-activity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ activity, time, image })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showStatus('Activity saved to Netlify!');
                    updatePreview();
                } else {
                    throw new Error('Server returned error status');
                }
            } catch (error) {
                showStatus('Error saving activity: ' + error.message, true);
                console.error('Save error:', error);
            } finally {
                // Reset button state
                saveButton.disabled = false;
                saveText.textContent = 'Save Activity';
                saveLoader.style.display = 'none';
            }
        }
        
        // Clear activity from Netlify
        async function clearActivity() {
            if (!confirm('Are you sure you want to clear the activity?')) {
                return;
            }
            
            // Show loading state
            const clearButton = document.getElementById('clearButton');
            const clearText = document.getElementById('clearText');
            const clearLoader = document.getElementById('clearLoader');
            
            clearButton.disabled = true;
            clearText.textContent = 'Clearing...';
            clearLoader.style.display = 'inline-block';
            
            try {
                const response = await fetch('/.netlify/functions/store-activity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ activity: '', time: '', image: '' })
                });
                
                if (response.ok) {
                    document.getElementById('activity').value = '';
                    document.getElementById('time').value = '';
                    document.getElementById('image').value = '';
                    updatePreview();
                    showStatus('Activity cleared');
                } else {
                    throw new Error('Server returned error status');
                }
            } catch (error) {
                showStatus('Error clearing activity: ' + error.message, true);
                console.error('Clear error:', error);
            } finally {
                // Reset button state
                clearButton.disabled = false;
                clearText.textContent = 'Clear Activity';
                clearLoader.style.display = 'none';
            }
        }
        
        // View activity page
        function viewActivity() {
            window.open('currentactivity.html', '_blank');
        }
        
        // Update preview
        function updatePreview() {
            const activity = document.getElementById('activity').value;
            const time = document.getElementById('time').value;
            const image = document.getElementById('image').value;
            
            let html = '';
            
            if (activity || time) {
                html = `
                    <p><strong>Activity:</strong> ${activity || 'Not set'}</p>
                    <p><strong>Time:</strong> ${formatTime(time) || 'Not set'}</p>
                `;
                
                if (image) {
                    html += `<p><strong>Image:</strong> ${image}</p>`;
                }
            } else {
                html = 'No activity set yet';
            }
            
            document.getElementById('previewContent').innerHTML = html;
        }
        
        // Format time for display
        function formatTime(time) {
            if (!time) return '';
            
            let [hours, minutes] = time.split(':');
            hours = parseInt(hours);
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            return `${hours}:${minutes} ${ampm}`;
        }
        
        // Show status message
        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'status error' : 'status';
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>